

# DNS
DNS是域名系统，其作用是：将域名解析为IP地址，客户端向DNS服务器（DNS服务器有自己的IP地址）发送域名查询请求，DNS服务器告知客户机Web服务器的IP 地址。
比如www.baidu.com为主机名。但是要说他的IP地址又有几个人知道呢？
虽然IP方便传输数据，但是不方便记忆，因此出现了DNS


DNS同时使用TCP和UDP协议
**DNS占用53号端口，同时使用TCP和UDP协议。**
（1）在区域传输的时候使用TCP协议
- 辅域名服务器会定时（一般3小时）向主域名服务器进行查询以便了解数据是否有变动。如有变动，会执行一次区域传送，进行数据同步。区域传送使用TCP而不是UDP，因为数据同步传送的数据量比一个请求应答的数据量要多得多。
- TCP是一种可靠连接，保证了数据的准确性。
>小Tips，TCP保证数据可靠采用了以下机制
>1. `序列号和确认应答`，TCP为每个发送的数据包分配一个序列号，接收方会对收到的数据包发送带有确认序列号的ACK响应。
>2. `超时重传`：如果发送方在预期时间内没有收到特定数据包的确认，它将认为该数据包丢失或损坏，并重新发送该数据包。TCP实现中使用了重传计时器来检测超时事件。
>3. `检验和`：TCP头包含一个校验和字段，用于检测数据在传输过程中是否受损。接收方对接收到的数据进行校验，如果`校验和不匹配，则数据包被丢弃`，并通过不发送ACK来触发发送方重传。
>4. `流量控制`：TCP使用滑动窗口协议来控制数据的发送速率，以避免拥塞和数据丢失。接收方会告知发送方其接收缓冲区的可用空间大小，发送方据此调整发送速率，从而避免数据发送过快导致接收方无法处理。
>5. 拥塞控制：TCP根据网络状况动态调整其发送速率，以避免网络拥塞。当网络开始出现拥塞迹象时，TCP会减少其数据的发送速率，使用`慢启动、拥塞避免`、快速重传和快速恢复等算法来管理数据流。
>6. `连接管理`：TCP使用三次握手建立连接，确保双方都准备好进行通信，并使用四次挥手断开连接，确保数据的有序关闭，且双方都确认没有更多数据待发送。
>
>   三次握手
>   ![](https://cdn.nlark.com/yuque/0/2020/png/1500604/1604023663279-0ea063ba-a06b-4f57-9aa9-0e2d1c8d373c.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_19%2Ctext_5b6u5L-h5YWs5LyX5Y-377ya5YmN56uv5YWF55S15a6d%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fformat%2Cwebp%2Fresize%2Cw_680%2Climit_0)
>   采用三次握手的原因，如果采用二次握手会怎么办
>   >如客户端发出连接请求，但因连接请求报文丢失而未收到确认，于是客户端再重传一次连接请求。后来收到了确认，建立了连接。数据传输完毕后，就释放了连接，客户端共发出了两个连接请求报文段，其中第一个丢失，第二个到达了服务端，但是第一个丢失的报文段只是在某些网络结点长时间滞留了，延误到连接释放以后的某个时间才到达服务端，此时服务端误认为客户端又发出一次新的连接请求，于是就向客户端发出确认报文段，同意建立连接，不采用三次握手，只要服务端发出确认，就建立新的连接了，此时客户端忽略服务端发来的确认，也不发送数据，则服务端一致等待客户端发送数据，浪费资源。
>   总结：TCP 三次握手的建立连接的过程就是相互确认初始序号的过程，告诉对方，什么样序号的报文段能够被正确接收。` 第三次握手的作用是客户端对服务器端的初始序号的确认`。如果只使用两次握手，那么服务器就没有办法知道自己的序号是否 已被确认。同时这样也是为了防止失效的请求报文段被服务器接收，而出现错误的情况。
>   
>   四次挥手
>   ![](https://cdn.nlark.com/yuque/0/2020/png/1500604/1604023663279-0ea063ba-a06b-4f57-9aa9-0e2d1c8d373c.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_19%2Ctext_5b6u5L-h5YWs5LyX5Y-377ya5YmN56uv5YWF55S15a6d%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fformat%2Cwebp%2Fresize%2Cw_680%2Climit_0)
>   采用四次挥手的原因
>   >因为当服务端收到客户端的SYN连接请求报文后，可以直接发送SYN+ACK报文。其中ACK报文是用来应答的，SYN报文是用来同步的。但是关闭连接时，当服务端收到FIN报文时，很可能并不会立即关闭SOCKET，所以只能先回复一个ACK报文，告诉客户端，“你发的FIN报文我收到了”。只有等到我服务端所有的报文都发送完了，我才能发送FIN报文，因此不能一起发送，故需要四次挥手。
>   TCP 使用四次挥手的原因是因为 TCP 的连接是全双工的，所以需要双方分别释放到对方的连接，单独一方的连接释放，只代 表不能再向对方发送数据，连接处于的是半释放的状态。
>   最后一次挥手中，客户端会等待一段时间再关闭的原因，`是为了防止发送给服务器的确认报文段丢失或者出错，从而导致服务器 端不能正常关闭。`
![](https://cdn.nlark.com/yuque/0/2020/png/1500604/1604022952153-a7106d22-225d-4081-9b0a-56b0d1876bc2.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_41%2Ctext_5b6u5L-h5YWs5LyX5Y-377ya5YmN56uv5YWF55S15a6d%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fformat%2Cwebp%2Fresize%2Cw_750%2Climit_0)




（2）在域名解析的时候使用UDP协议
- 客户端向DNS服务器查询域名，一般返回的内容都不超过512字节，`用UDP传输即可`。不用经过三次握手，`这样DNS服务器负载更低，响应更快`。理论上说，客户端也可以指定向DNS服务器查询时用TCP，但事实上，很多DNS服务器进行配置的时候，仅支持UDP查询包。

DNS的完整流程
- 首先会在**浏览器的缓存**中查找对应的IP地址，如果查找到直接返回，若找不到继续下一步
- 将请求发送给**本地DNS服务器**，在本地域名服务器缓存中查询，如果查找到，就直接将查找结果返回，若找不到继续下一步
- 本地DNS服务器向**根域名服务器**发送请求，根域名服务器会返回一个所查询域的顶级域名服务器地址
- 本地DNS服务器向**顶级域名服务器**发送请求，接受请求的服务器查询自己的缓存，如果有记录，就返回查询结果，如果没有就返回相关的下一级的权威域名服务器的地址
- 本地DNS服务器向**权威域名服务器**发送请求，域名服务器返回对应的结果
- 本地DNS服务器将返回结果保存在缓存中，便于下次使用
- 本地DNS服务器将返回结果返回给浏览器

DNS解析
DNS解析是一个包含迭代查询和递归查询的过程
- `递归查询`：是查询请求发出后，域名服务器代为向下一级域名服务器发出请求，最后向用户返回查询的最终结果。使用递归 查询，用户只需要发出一次查询请求。
- `迭代查询`：是查询请求后，域名服务器返回单次查询的结果。下一级的查询由用户自己请求。使用迭代查询，用户需要发出 多次的查询请求。


